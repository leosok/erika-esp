


# Based on https://bradgignac.com/2014/05/12/sending-email-with-python-and-the-mailgun-api.html

import json
import urequests as requests
from utils.urlencode import urlencode
from secrets import MAILGUN_API_KEY, CONFIG_MY_EMAIL
import binascii

tsttxt = "Lorem ipsum dolor sit ameti, consectetur elit. Proin bibendum velit lacus. Suspendisse at metus leo, vel pretium dolor. Donec dignissim accumsan augue, vel dictum elit placerat ac. Fusce non ligula est. In tempor cursus imperdiet. Nunc ornare, enim at elementum hendrerit, lectus enim volutpat diam, at ornare enim ante sed odio. Fusce ac mauris et diam pharetra tincidunt. In placerat quam quis elit facilisis ut consectetur purus mattis. Nullam vulputate auctor sem, quis ultrices risus ultrices molestie. Maecenas eu urna vitae massa aliquam egestas a ut nibh. Maecenas lacinia aliquam ullamcorper. Integer bibendum suscipit fringilla. Donec mattis turpis eu nunc laoreet vitae scelerisque neque blandit.  Sed massa leo, blandit eget varius quis, cursus ut est. Pellentesque eget bibendum nunc. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet magna in leo dapibus auctor. Ut in neque dolor. Vivamus euismod auctor risus, adipiscing tincidunt justo aliquam vel. Quisque hendrerit enim a lorem posuere porta. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In hac habitasse platea dictumst. Nullam vulputate quam a diam congue egestas. Integer eleifend, urna sed tempor aliquam, quam elit consequat neque, vitae condimentum ligula metus a neque.  Sed nec vestibulum nisl. Aliquam sed massa vel magna tincidunt tristique. Etiam non dolor augue, vel pulvinar dolor. Cras vitae ipsum nulla. Cras mauris odio, venenatis et feugiat vel, adipiscing sit amet tortor. Aliquam dignissim, sapien at congue lacinia, nisl ante pharetra massa, egestas ultrices neque quam eget arcu. Pellentesque ac mollis quam. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Sed suscipit leo eleifend turpis bibendum viverra. Nullam dui elit, interdum ac ornare non, sollicitudin non lectus.  Mauris tincidunt nisl elementum lorem bibendum eu fringilla tellus consectetur. Integer fermentum facilisis iaculis. Etiam dignissim tempus dignissim. Aliquam commodo mauris nec ipsum semper sodales. Duis vitae dui neque. Mauris non sapien leo. Ut facilisis sapien at sem semper vulputate facilisis vel dui. Aliquam mattis tempor tincidunt. Sed et erat risus. Etiam molestie posuere mollis. Nam ultricies, risus nec bibendum facilisis, lorem sem suscipit dui, quis scelerisque nibh libero eu erat. Morbi arcu ante, venenatis non posuere id, dapibus sed leo. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean velit nulla, suscipit interdum accumsan et, vulputate et nisi. Morbi accumsan condimentum ligula. Cras nec ligula nisl, sit amet aliquam lectus. Duis ante orci, viverra vitae pellentesque eget, porta quis dui. Etiam lobortis feugiat ligula id egestas. Quisque nec est nec nisl accumsan volutpat vel at leo. Fusce a vulputate nunc.  Donec nibh turpis, feugiat ut congue ut, faucibus at sem. Etiam ultricies fringilla est nec condimentum. Cras lacinia nulla nec orci aliquet varius et vitae sem. Nunc at nunc a enim consectetur suscipit at eu ante. Donec lacus turpis, lobortis sed tempor quis, fermentum non lectus. Aliquam ultrices cursus libero eget laoreet. Suspendisse sollicitudin est ultrices leo cursus dictum. Quisque porta, nunc id auctor faucibus, lacus arcu condimentum lorem, ut accumsan libero tellus sit amet lacus. Ut sit amet sapien imperdiet urna eleifend ultricies quis a nisl. Integer orci sem, aliquet eu tempor non, semper sollicitudin felis. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;  Aenean at augue at metus ornare cursus at vitae eros. Pellentesque magna nisi, viverra quis luctus sit amet, sodales eu felis. Nullam at augue mi, vitae aliquam purus. Aliquam feugiat malesuada magna, molestie placerat diam adipiscing vel. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Nunc fermentum orci nec nisi dapibus vel porta ligula blandit. Nunc nibh justo, eleifend eget laoreet sit amet, semper in metus. Ut vehicula luctus lacus eu elementum. In lorem lorem, semper id elementum in, volutpat nec ante. Morbi sapien lorem, fringilla in pretium at, posuere sit amet libero. Donec rutrum placerat sem a pretium. Quisque euismod justo a erat ornare elementum scelerisque tortor commodo. Suspendisse neque tellus, interdum eget convallis fringilla, ullamcorper a urna. Donec fermentum ultricies nulla sed sollicitudin. Aenean sed tortor mi.  Donec interdum, turpis sed tincidunt ullamcorper, mauris massa vehicula mauris, sit amet mollis nunc lectus accumsan purus. Nam lorem diam, semper imperdiet condimentum in, laoreet nec tortor. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Maecenas pretium facilisis dui. Quisque blandit nisl non odio sollicitudin pulvinar. Maecenas eu leo tempor velit tincidunt porttitor. Vestibulum ligula velit, pharetra sed aliquet et, ultricies et erat. Pellentesque et est a libero luctus porttitor eget pulvinar mi. Phasellus sodales iaculis fringilla. Suspendisse feugiat ultrices eleifend. Aliquam iaculis leo in velit tempus quis accumsan eros bibendum. Maecenas sodales scelerisque lorem, et mattis neque tincidunt eu. Pellentesque sit amet sapien nisi, ut pretium est. Donec lacus velit, egestas non rhoncus et, mattis commodo augue. Vivamus et risus orci, sed pharetra ante. Duis fringilla ultrices lectus non ullamcorper. Quisque id sem est, non fringilla nunc. Donec pulvinar varius orci.  Fusce quis urna eget quam aliquam fermentum id at nisi. Aenean ac ipsum et leo ultricies convallis. Suspendisse nisi eros, eleifend eu suscipit sed, accumsan sed purus. Aenean fermentum, enim tempus mollis facilisis, eros nisi consequat velit, a viverra nisl nulla eu nulla. Mauris non velit in ligula consectetur consectetur id id elit. Phasellus pellentesque iaculis luctus. Mauris viverra, purus et eleifend porta, eros nisi blandit magna, vitae aliquam orci eros id nunc. Lorem ipsum dolor sit amet, consectetur adipiscing elit. In sit amet enim at tortor varius tristique. Nullam sit amet iaculis ipsum. Etiam commodo porttitor velit, porta tempor ipsum pharetra id. Mauris magna velit, condimentum vitae tempor sollicitudin, tempor id elit. Duis id diam augue. Praesent id tortor nibh, quis egestas justo. Maecenas scelerisque ornare dui eget fringilla. Nunc at turpis sem, ut pellentesque tellus. Fusce nec est vitae orci auctor facilisis. Vestibulum dolor metus, convallis a sodales in, feugiat eu enim.  Cras hendrerit suscipit ultricies. Suspendisse fermentum erat sit amet diam imperdiet pulvinar. Curabitur ipsum risus, placerat eget ultricies quis, pellentesque vel orci. Donec sapien libero, laoreet et rutrum vitae, vulputate quis ante. Cras consectetur neque in nulla convallis pellentesque nec eget est. Vivamus tincidunt vehicula pretium. Duis nec egestas ligula. In ligula neque, viverra ut ornare et, adipiscing vitae enim. Mauris ac sagittis libero. Cras placerat, erat in ornare accumsan, erat velit fringilla risus, at porttitor massa est ac lectus. Nunc condimentum commodo dolor non consequat. Nulla vel ante eget erat luctus condimentum non sit amet tortor. Ut id massa id ligula adipiscing euismod vitae id diam.  Donec vehicula rhoncus ipsum at tempor. Nulla volutpat nisi id metus sodales a commodo quam ullamcorper. Curabitur ac erat a purus tempor porta eu vel erat. Sed placerat consectetur arcu non fringilla. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Curabitur a dolor nec quam malesuada tempor a bibendum nulla. Duis tincidunt hendrerit volutpat. Maecenas tempus scelerisque rhoncus. Pellentesque sodales nisi ut odio pretium gravida. Vivamus eget mi vel nisi lobortis vulputate id et eros. Donec vel augue velit, vitae volutpat nisl. Phasellus nec varius mauris. Donec mattis ligula lectus. Ut ut eros sed nulla posuere pharetra. Sed vitae bibendum erat. In mauris orci, sodales a porttitor vel, ornare ac odio. Vestibulum dolor quam, lobortis id malesuada eu, tempor vel lacus.  Nunc imperdiet lorem a mi lobortis volutpat. Duis malesuada purus sed mi tempus sed euismod enim sagittis. Aenean quam metus, feugiat eu tempor vel, blandit vel enim. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec eget velit diam. In ac quam eget massa tempus adipiscing eget bibendum odio. Quisque mollis cursus mauris, at pretium lorem vestibulum eget. Mauris ac molestie est. Quisque tempus orci eget eros fringilla a dictum eros imperdiet. Nulla sollicitudin, lacus in semper egestas, lorem arcu dapibus lacus, eu iaculis turpis est et dui. Vestibulum sed augue eu lectus eleifend adipiscing a id justo. In hac habitasse platea dictumst. Cras vitae metus ac lacus eleifend euismod a sit amet justo.  Vestibulum dolor nisi, scelerisque quis malesuada venenatis, semper in elit. Morbi scelerisque pulvinar lectus, a vestibulum ligula cursus tincidunt. Vestibulum egestas, est et adipiscing aliquet, risus enim feugiat magna, nec egestas magna felis non elit. Nulla facilisi. Curabitur tempor consequat metus quis mattis. Cras sed quam eu sapien pharetra auctor quis fringilla tellus. Donec magna tellus, mattis sit amet rhoncus at, mollis at justo. Curabitur molestie orci eu eros aliquam tristique. Donec lobortis mattis mi, rutrum commodo massa ultrices id. Duis fermentum accumsan augue et congue. Donec sed orci sit amet elit ultrices pharetra. In hac habitasse platea dictumst. In non leo ac ligula interdum pellentesque."


def post_formdata(url, data=None, json=None, headers=None):
    if isinstance(data, dict):
        data = urlencode(data)
        print(data)
        headers = {} if headers is None else headers
        headers['Content-Type'] = 'application/x-www-form-urlencoded'
    return requests.post(url, data=data, json=json, headers=headers)


def send_mailgun(mail_text, mail_from= "erika@news.belavo.co",mail_to=CONFIG_MY_EMAIL, mail_subject="Erika Transcript"):

    headers = {} 
    auth_str = b"api:{}".format(MAILGUN_API_KEY)
    # transcoding adds a \n character, we need to remove
    auth_base = binascii.b2a_base64(auth_str).strip()
    headers["Authorization"] = b"Basic " + auth_base
    #headers["Authorization"] = "Basic YXBpOmJkYmRjYjg0M2EzZGZiYzI1YzQ4Y2Q4OTIwZjY1YTUxLTM5MzliOTNhLWQ5NWU2NWUz"

    ajson = {
            "from": mail_from,
            "to": mail_to,
            "subject":mail_subject,
            "text": mail_text}
    
    print(ajson)

    r =  post_formdata(
        "https://api.mailgun.net/v3/news.belavo.co/messages",
        headers=headers,
        data=ajson)
    
    print(r.text)